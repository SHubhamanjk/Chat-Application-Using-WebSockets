<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #container { display: flex; height: 100vh; }
    #rooms { width: 20%; border-right: 1px solid #ccc; padding: 10px; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; }
    #input { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    #input input { flex: 1; margin-right: 8px; }
  </style>
</head>
<body>
<div id="container">
  <div id="rooms">
    <h3>Rooms</h3>
    <div style="margin-bottom: 10px;">
      <input id="new-room-input" placeholder="Room name..." style="width: 70%;" />
      <button id="create-room-btn" style="width: 25%;">Create</button>
    </div>
    <div style="margin-bottom: 10px;">
      <input id="join-room-input" placeholder="Room ID..." style="width: 70%;" />
      <button id="join-room-btn" style="width: 25%;">Join</button>
    </div>
    <h4 style="margin: 10px 0 5px 0; font-size: 14px;">Available Rooms:</h4>
    <ul id="room-list" style="list-style: none; padding: 0;"></ul>
  </div>
  <div id="chat">
    <div id="current-room" style="padding: 10px; background: #f0f0f0; font-weight: bold;">
      No room selected
    </div>
    <div id="messages"></div>
    <div id="input">
      <input id="message-input" placeholder="Type message..." />
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const username = prompt("Enter username") || "user" + Math.floor(Math.random()*1000);
  let currentRoom = null;

  const socket = io(); // connects to same origin

  socket.on("connect", () => {
    console.log("Connected:", socket.id);
  });

  socket.on("system_message", (data) => {
    appendMessage(`[SYSTEM] ${data.content}`);
  });

  socket.on("new_message", (data) => {
    if (data.room === currentRoom) {
      appendMessage(`${data.sender}: ${data.content}`, data.sender === username);
    }
  });

  function appendMessage(text, isOwn = false) {
    const box = document.getElementById("messages");
    const p = document.createElement("p");
    p.textContent = text;
    p.style.margin = "5px 0";
    p.style.padding = "8px 12px";
    p.style.borderRadius = "8px";
    p.style.maxWidth = "70%";
    p.style.wordWrap = "break-word";
    
    if (isOwn) {
      p.style.backgroundColor = "#dcf8c6";
      p.style.marginLeft = "auto";
      p.style.textAlign = "right";
    } else {
      p.style.backgroundColor = "#f0f0f0";
      p.style.marginRight = "auto";
    }
    
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
  }

  // Load rooms from REST API
  function loadRooms() {
    fetch("/rooms")
      .then(res => res.json())
      .then(rooms => {
        const ul = document.getElementById("room-list");
        ul.innerHTML = "";
        if (rooms.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No rooms yet";
          li.style.fontStyle = "italic";
          li.style.color = "#999";
          li.style.padding = "5px 0";
          ul.appendChild(li);
        }
        rooms.forEach(room => {
          const li = document.createElement("li");
          li.textContent = room.name;
          li.style.cursor = "pointer";
          li.style.padding = "8px";
          li.style.marginBottom = "5px";
          li.style.backgroundColor = "#f9f9f9";
          li.style.borderRadius = "4px";
          li.style.transition = "background 0.2s";
          li.onmouseover = () => li.style.backgroundColor = "#e0e0e0";
          li.onmouseout = () => li.style.backgroundColor = "#f9f9f9";
          li.onclick = () => joinRoom(room.id, room.name);
          ul.appendChild(li);
        });
      });
  }
  
  loadRooms();
  
  // Create room
  document.getElementById("create-room-btn").onclick = () => {
    const input = document.getElementById("new-room-input");
    const name = input.value.trim();
    if (!name) {
      alert("Please enter a room name");
      return;
    }
    
    const roomId = name.toLowerCase().replace(/\s+/g, '-');
    fetch("/rooms/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: roomId, name: name })
    })
    .then(res => {
      if (!res.ok) throw new Error("Failed to create room");
      return res.json();
    })
    .then((room) => {
      input.value = "";
      loadRooms();
      // Auto-join the created room
      joinRoom(room.id, room.name);
    })
    .catch(err => {
      console.error("Error creating room:", err);
      alert("Failed to create room. It might already exist.");
    });
  };
  
  // Join room by ID
  document.getElementById("join-room-btn").onclick = () => {
    const input = document.getElementById("join-room-input");
    const roomId = input.value.trim();
    if (!roomId) {
      alert("Please enter a room ID");
      return;
    }
    
    input.value = "";
    joinRoom(roomId, roomId);
  };

  function joinRoom(roomId, roomName) {
    if (currentRoom) {
      socket.emit("leave_room", { room: currentRoom, username });
    }
    currentRoom = roomId;
    document.getElementById("messages").innerHTML = "";
    document.getElementById("current-room").textContent = `Room: ${roomName || roomId}`;

    // join via socket.io
    socket.emit("join_room", { room: currentRoom, username });

    // load history via REST
    fetch(`/messages/${currentRoom}`)
      .then(res => res.json())
      .then(msgs => {
        msgs.forEach(m => appendMessage(`${m.sender}: ${m.content}`));
      });
  }

  function sendMessage() {
    const input = document.getElementById("message-input");
    const text = input.value.trim();
    if (!currentRoom) {
      alert("Please join a room first!");
      return;
    }
    if (!text) {
      return;
    }
    console.log("Sending message:", text);
    
    // Show own message immediately
    appendMessage(`${username}: ${text}`, true);
    
    socket.emit("send_message", {
      room: currentRoom,
      sender: username,
      content: text
    });
    input.value = "";
  }

  document.getElementById("send-btn").onclick = sendMessage;
  
  document.getElementById("message-input").onkeypress = (e) => {
    if (e.key === "Enter") {
      sendMessage();
    }
  };
</script>
</body>
</html>
